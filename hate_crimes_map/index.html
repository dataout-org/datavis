<!DOCTYPE html>
<!--
Developed by dataout.org

Released under the CC-BY-SA 4.0 license
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://d3js.org/d3.v7.min.js"></script>

<style id="map-css">

  body {
    background: transparent;
  }

  h2 {
    padding-top: 10px;
    padding-bottom: 10px;
    padding-left: 20px;
  }

  #info_box {
    background-color: rgb(244, 244, 244);;
    color: black;
    padding: 12px;
    border-radius: 4px;
    font-size: 14px;
    max-width: 830px;
  }

  #info_box .disclaimer {
    font-style: italic;
    color: #575757;
  }


  #map_table {
  }

  #rf_map_container {
    margin-bottom: -80px;
  }

  #rf_map {
    margin-top:20px;
  }

  #table-container{
    max-width:830px;
  }

  .container-fluid{
    margin-left: 0 !important;
  }


  #data-table tbody{
    background-color: rgb(244, 244, 244);
    font-size:12px;
    color: black;
  }

  thead {
    font-size:12px;
    text-align: left;
    background-color: rgb(244, 244, 244);
    color: black;
  }

  tbody tr:hover{
    background-color: rgb(179, 179, 179) !important;
  }

  .table thead th {
    vertical-align:top;
  }

  #names_container .name {
    font-size:10px !important;
    pointer-events:none; /* make sure the tile text is not selected */
  }

  /* -- occupied regions */

  #tiles_container rect[id="91"] {
    stroke: black;
    stroke-width: 1px;
    stroke-dasharray: 3 2;
  }

  #tiles_container rect[id="92"] {
    stroke: black;
    stroke-width: 1px;
    stroke-dasharray: 3 2;
  }

  /* occupied regions -- */

  #tooltip {
    position: absolute;
    min-width:80px;
    font-size:10px;
    background-color: rgba(0, 0, 0);
    color: white;
    padding: 4px;
    border-radius: 4px;
    pointer-events: none; /* the tooltip shouldn't interfere with mouse events */
    visibility: hidden; /* the tooltip is hidden by default */
  }

  @media (min-width: 576px) {

  }
</style>

</head>

<body>
  
  <h2>Hate crimes 2019</h2>

  <div class="container-fluid" id="map_table">
    
  <div id="rf_map_container">
    
    <div id="info_box">
      <p>This tiled map of Russia shows the number of hate crime victims by regions: darker regions have more victims. Hover on the tiles to see more info. See the full table under the map. Click on a region to filter the table. <br>
      <div class="disclaimer">* Sevastopol and Crimea are the territories occupied by Russia. We presented them on this map, because data for these regions was availbale on the Russian court websites.</div></p>
      </div>

    <svg id="rf_map" width="800" height="600"></svg>
    
  </div>
  
  <div id="tooltip"></div>
    
  <div class="container-fluid" id="table-container">
    <div class="table-sm">
    <table class="table table-hover table-dark" id="data-table">
       <thead>
           <tr></tr>
       </thead>
       <tbody class="data-table-body"></tbody>
      </table>
      </div>
     </div>
  
      </tbody>
    </table>
  </div>

<script id="map-javascript">

// Load the SVG map dynamically from GitHub
d3.text("https://raw.githubusercontent.com/dataout-org/datavis/main/rf_tiled_map/tilemaprf_xy.svg").then(function(svgString) {
  var parser = new DOMParser();
  var xml = parser.parseFromString(svgString, "image/svg+xml");
  var importedNode = document.importNode(xml.documentElement, true);
  document.getElementById("rf_map").appendChild(importedNode);

  var spreadsheetUrl = "https://docs.google.com/spreadsheets/d/18NSZd6RgeSjEW1RzbYY4lQbFYHWaGKIMb8KLGQuZfDc/export?format=csv";

  // loading csv from the spreadsheet
  d3.text(spreadsheetUrl)
    .then(function(csvData) {
      // parsing the csv data
      var data = d3.csvParse(csvData);
    
    // converting string numbers to int
    data.forEach(function(d) {
      d.n_victims = +d.n_victims;
      d.n_fatalities = +d.n_fatalities;
      d.n_crimes = +d.n_crimes;
    });
    

    // group data by region_code and calculate total victims for each region
    var regionData = d3.group(data, d => d.region_code);
    var victimCounts = new Map();

    regionData.forEach(function(value, key) {
      var totalVictims = d3.sum(value, d => d.n_victims);
      victimCounts.set(key, totalVictims);
    });

    // define color scale based on the range of victim counts
    var maxVictims = d3.max(Array.from(victimCounts.values()));
    var colorScale = d3.scaleSequential()
      .domain([0, maxVictims])
      .interpolator(function(t) {
        return d3.interpolateReds(t);
      });

    // select the group containing the tiles
    var tilesContainer = d3.select("#tiles_container");
    var textContainer = d3.select("#names_container");
    
    // select the tooltip element
    var tooltip = d3.select("#tooltip");

    // apply colors to the tiles based on the number of victims
    tilesContainer.selectAll("rect").each(function() {
      var tile = d3.select(this);
      var regionCode = tile.attr("id");
      var regionVictims = victimCounts.get(regionCode);
      var fillColor;
      if (regionVictims !== undefined) {
        fillColor = colorScale(regionVictims);
      } else {
        fillColor = "rgb(244, 244, 244)"; // color tiles with no values
      }
  
      // apply fill color
      tile.style("fill", fillColor);
      
      // determine text color dynamically based on perceived brightness
      var textColor = getContrastColor(fillColor);

      // select text element and change color
      var textElement = d3.select("#name_" + regionCode);
      textElement.style("fill", textColor);
      
      // add hover event listeners for tiles with data
      if (regionVictims !== undefined) {
        tile.on("mouseover", function(event) {
          // get tile dimensions and position
          var tileRect = tile.node().getBoundingClientRect();
          var tileLeft = tileRect.left + window.scrollX;
          var tileTop = tileRect.top + window.scrollY;
          // display tooltip with region name and number of victims
          tooltip.style("visibility", "visible")
                 .html(tile.attr("regionNameEn") + "<br> Victims: " + regionVictims)
                 .style("left", (tileLeft + tileRect.width / 2) + "px")
                 .style("top", (tileTop + (tileRect.height / 2)) + "px");
        })
        .on("mouseout", function() {
          // hide tooltip on mouseout
          tooltip.style("visibility", "hidden");
        })
        .on("click", function() {
            // reset previously selected tiles
            textContainer.selectAll("text").style("font-weight", "normal");

            // highlight the clicked tile's name by making it bold
            textElement.style("font-weight", "bold");
            // filter the CSV data for cases belonging to the clicked region
            var cases = data.filter(function(d) {
              return d.region_code === regionCode;
            });
        
      // generating HTML table dynamically
            var tableHTML = "<thead><tr><th>Case Number</th><th>Region (RU)</th><th>Article</th><th>Fatalities</th><th>Victims</th><th>Crimes</th><th>Crime Type</th><th>Source</th></tr></thead><tbody>";
            cases.forEach(function(d) {
              tableHTML += "<tr><td>" + d.case_number + "</td><td>" + d.region_name_ru + "</td><td>" + d.article + "</td><td>" + d.n_fatalities + "</td><td>" + d.n_victims + "</td><td>" + d.n_crimes + "</td><td>" + d.crime_type + "</td><td>" + d.source + "</td></tr>";
            });
            tableHTML += "</tbody>";

            // fill the table with the generated HTML
            document.querySelector("#data-table").innerHTML = tableHTML;
          });
      }
    });
    
    // generate initial HTML table with all cases
    var initialTableHTML = "<thead><tr><th>Case Number</th><th>Region (RU)</th><th>Article</th><th>Fatalities</th><th>Victims</th><th>Crimes</th><th>Crime Type</th><th>Source</th></tr></thead><tbody>";
    data.forEach(function(d) {
      initialTableHTML += "<tr><td>" + d.case_number + "</td><td>" + d.region_name_ru + "</td><td>" + d.article + "</td><td>" + d.n_fatalities + "</td><td>" + d.n_victims + "</td><td>" + d.n_crimes + "</td><td>" + d.crime_type + "</td><td>" + d.source + "</td></tr>";
    });
    initialTableHTML += "</tbody>";

    // fill the initial table with the generated HTML
    document.querySelector("#data-table").innerHTML = initialTableHTML;
  });
});


// Function to calculate perceived brightness based on HSL color space
function getPerceivedBrightness(color) {
  var rgb = d3.rgb(color);
  var hsl = d3.hsl(rgb);
  return hsl.l;
}

// Function to dynamically determine text color based on perceived brightness
function getContrastColor(bgColor) {
  var brightness = getPerceivedBrightness(bgColor);
  return brightness > 0.5 ? "black" : "white"; // black text for light backgrounds, white text for dark backgrounds
}

</script>

</body>

</html>