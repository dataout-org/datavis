<!DOCTYPE html>
<!--
Developed by dataout.org

Released under the CC-BY-SA 4.0 license
-->
<html>
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Hate crimes barchart / Developed for greyrainbow.dataout.org</title>

<link rel="stylesheet" href="barchart_style.css">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>

<div class="container-fluid" id="github_description">
  <p id="text_description">
    This bar chart displays the number of hate crimes against LGBTQ+ people in Russia according to the court cases data. This page is developed for the website greyrainbow.dataout.org. You can freely reuse and adapt this visualisation with the license CC-BY-SA 4.0.
  </p>
</div>

<!--  The content below is fetched by hatecrimes.dataout.org -->

<div id="content_to_fetch">
  <div class="container-fluid" id="barchart">
    <div class="row legend_bar">
           <div class="col-md-auto n_crimes_legend">Кол-во преступлений</div>
           <div class="col-md-auto n_victims_legend">включая пострадавших</div>
           <div class="col-md-auto n_fatalities_legend">включая погибших</div>
       
    </div>
    <div class="row scroll_explainer">
        <p class="p_scroll"><i class="bi bi-arrows scroll_arrows"></i>Прокручивайте горизонтально</p>
    </div>

    <div class="row chart">
        <div class="col-md-auto chart_col" id="chart_col">
          <!-- bar chart goes here -->
            <div class="background_law_info" id="law_12_13">
                <span class="law_info_text">Принятие закона о "гей-пропаганде"</span>
            </div>

            <div class="background_law_info" id="law_22_23">
                    <span class="law_info_text">Расширение закона о "гей-пропаганде"</span>
            </div>

            <div class="info_icon" id="explainer_2013">
                <i class="bi bi-info-circle-fill" data-bs-toggle="tooltip" data-bs-title="Эта кривая показывает среднее значение количества преступлений за соседние 2 года. Мы смотрим на среднее значение, потому что год опубликования судебных приговоров не всегда совпадает с годом совершения преступения."></i>
            </div>

        </div>
      </div>
  
  </div>

  <script id="d3vis_barchart">

    // chart dimensions and margins
    const margin = {top: 10, right: 0, bottom: 20, left: 0};
    
    width = 760 - margin.left - margin.right,
    height = 480 - margin.top - margin.bottom;

    // appending SVG
    const svg = d3.select("#chart_col")
        .append("svg")
            .attr("id","svg_chart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("viewbox", "20 -20 760 480")
        .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

    const defs = svg.append("defs");

    defs.append("pattern")
        .attr("id", "lawHash")
        .attr("width", 4)
        .attr("height", 4)
        .attr("patternUnits", "userSpaceOnUse")
        .append("path")
            .attr("d", "M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2") // diagonal pattern "up right"
            .attr("stroke", "rgb(58, 58, 58)")
            .attr("stroke-width", 0.6);

    
    // to calculate smooth average over 2 years
    function getSmoothAverage(data, key) {
        const smoothed = [];
        for (let i = 0; i < data.length; i++) {
            if (i < data.length - 1) { // Check if there's a next year (pair)
                const curr = data[i][key];    // Current year's value
                const next = data[i + 1][key]; // Next year's value
                smoothed.push((curr + next) / 2); // Average of current and next year
            }
        }
        return smoothed;
    }

    // fetching the data
    d3.csv("hatecrimes_overall_2010_2023.csv").then(function(data) {
        data.forEach(d => {
                d.year = d.year.toString().trim(); // convert years to str, trim whitespace
                d.n_crimes = +d.n_crimes; // N crimes
                d.n_victims = +d.n_victims; // N victims
                d.n_fatalities = +d.n_fatalities; // N fatalities
            });

        // all years
        const years = data.map(d => d.year);

        // x axis for years
        const x = d3.scaleBand()
            .domain(years)
            .range([0, width])
            .padding(0.12);

        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickSize(0))
            .attr("class", "year_label")
            .selectAll("text")
                .attr("transform", "translate(0,4)rotate(0)")
                .style("text-anchor", "middle");

        // add y axis
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.n_crimes)])
            .nice()
            .range([height, 0]);

        // tick line
        svg.selectAll(".domain")
            .attr("class", "x_line");

        // smooth averages for each key
        const smoothCrimes = getSmoothAverage(data, 'n_crimes');
        const smoothVictims = getSmoothAverage(data, 'n_victims');
        const smoothFatalities = getSmoothAverage(data, 'n_fatalities');

        function drawSmoothAverage(data, smoothData, color) {
            const line = d3.line()
                .x((d, i) => x(data[i].year) + x.bandwidth()/ 2)
                .y((d, i) => y(smoothData[i]))
                .curve(d3.curveMonotoneX);

            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("class", "smooth_avg_line")
                .attr("stroke", color)
                .attr("stroke-width", 1)
                .style("stroke-linecap", "round")
                .attr("d", line);
        }
        
        const backgroundLawMargin = 2;

        // law 2012–2013 background
        const x0_12_13 = x("2012") - backgroundLawMargin; // start position
        const x1_12_13  = x("2013") + x.bandwidth() + backgroundLawMargin; // end position
        const backgroundLawWidthTotal = x1_12_13 - x0_12_13; // total width

        svg.append("rect")
            .attr("class", "law_background")
            .attr("x", x0_12_13)
            .attr("y", -36)
            .attr("width", backgroundLawWidthTotal)
            .attr("height", height + 36)
            .style("fill", "url(#lawHash)")
            .style("stroke", "none");

        // positioning of the info
        const info_12_13 = document.getElementById("law_12_13");
        info_12_13.style.width = `${backgroundLawWidthTotal - 12}px`;
        info_12_13.style.left = `${(x0_12_13 + 10)}px`;
        info_12_13.style.top = "120px";

        // law 2022–2023 background
        const x0_22_23 = x("2022") - backgroundLawMargin; // start position
        const x1_22_23  = x("2023") + x.bandwidth() + backgroundLawMargin; // end position

        svg.append("rect")
            .attr("class", "law_background")
            .attr("x", x0_22_23)
            .attr("y", -36)
            .attr("width", backgroundLawWidthTotal) // width stays the same for 2 bars
            .attr("height", height + 36)
            .style("fill", "url(#lawHash)")
            .style("stroke", "none");

        // positioning of the info
        const info_22_23 = document.getElementById("law_22_23");
        info_22_23.style.width = `${backgroundLawWidthTotal - 12}px`;
        info_22_23.style.left = `${(x0_22_23 + 10)}px`;
        info_22_23.style.top = "76px";

        // N crimes bars
        svg.selectAll(".n_crimes")
            .data(data)
            .enter()
            .append("rect")
                .attr("class", "n_crimes")
                .attr("x", d => x(d.year))
                .attr("y", d => y(d.n_crimes))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.n_crimes));

        // N crimes labels
        svg.selectAll(".n_crimes-label")
            .data(data)
            .enter()
            .append("text")
                .attr("id", d => `n_crimes_label_${d.year}`)
                .attr("class", "label n_crimes_label")
                .attr("x", d => x(d.year) + 22)
                .attr("y", d => y(d.n_crimes) - 4)
                .text(d => d.n_crimes);

        // N fatalities bars (y = 0)
        svg.selectAll(".n_fatalities")
        .data(data)
        .enter()
        .append("rect")
            .attr("class", "n_fatalities")
            .attr("x", d => x(d.year))
            .attr("y", d => y(d.n_fatalities))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.n_fatalities));

        // N fatalities labels
        svg.selectAll(".n_fatalities_label")
                .data(data)
                .enter()
                .append("text")
                    .attr("id", d => `n_fatalities_label_${d.year}`)
                    .attr("class", "label n_fatalities_label")
                    .attr("x", d => x(d.year) + 22)
                    .attr("y", d => y(d.n_fatalities) + 16)
                    .text(d => d.n_fatalities);

        // N victims bars (incl. N fatalities)
        svg.selectAll(".n_victims")
            .data(data)
            .enter()
            .append("rect")
                .attr("class", "n_victims")
                .attr("x", d => x(d.year))
                .attr("y", d => y(d.n_victims))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.n_victims - d.n_fatalities));

        // N victims labels
        svg.selectAll(".n_victims_label")
            .data(data)
            .enter()
            .append("text")
                .attr("id", d => `n_victims_label_${d.year}`)
                .attr("class", "label n_victims_label")
                .attr("x", d => x(d.year) + 22)
                .attr("y", d => y(d.n_victims) + 14)
                .text(d => d.n_victims);

        // drawing smooth averages lines
        drawSmoothAverage(data, smoothCrimes, "rgb(151, 151, 151)");

        // correcting the label positioning, so they're visible
        d3.select("#n_crimes_label_2018").attr("y", 108);

        const x0_14 = x("2014"); // start position
        // append explainers
        d3.select("#explainer_2013")
            .style("position", "relative")
            .style("left", `${x0_14 + 16}px`)
            .style("top", "50px");
           
    });

    // auto scroll on mobile devices
    let scrollInterval;
    let userInteracted = false; // flag for user interaction

     // scrolling to the right automatically
     function autoScroll(containerId) {
        const container = document.getElementById(containerId);
        let currentScroll = 0;
        const maxScroll = container.scrollWidth - container.clientWidth; // max scrollable width

        const scrollInterval = setInterval(() => {
            // stop if user interacts
            if (userInteracted) {
                clearInterval(scrollInterval);
                return;
            }
            currentScroll += 2; // scroll speed
            container.scrollLeft = currentScroll;

            // stop if the end is reached
            if (currentScroll >= maxScroll) {
                clearInterval(scrollInterval);
            }
        }, 30); // interval
    }

    // detecting user clicks
    function detectUserInteracton(containerId) {
        const container = document.getElementById(containerId);

        container.addEventListener('click', () => {
            userInteracted = true;
            clearInterval(scrollInterval);
        });
    }

       // determining the visibility of the chart with Intersection Observer
       function observeVisibility(targetId, callback) {
        const target = document.getElementById(targetId);

        const observer = new IntersectionObserver((entries, observerInstance) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    callback();
                    observerInstance.unobserve(target);
                }
            });
        }, { threshold: 0.5 }); // 50% is visible

        observer.observe(target);
    }

    observeVisibility('chart_col', () => {
        detectUserInteracton('chart_col');
        autoScroll('chart_col');
    });

    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    
  </script>

</div>

</body>

</html>
