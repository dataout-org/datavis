<!DOCTYPE html>
<!--
Developed by dataout.org

Released under the CC-BY-SA 4.0 license
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="map_style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

</head>

<body>

  <div class="container-fluid" id="map_table">
    
  <div id="rf_map_container">
    
    <div id="info_box">
      <p>This tiled map of Russia shows the number of hate crime victims by regions: darker regions have more victims. Hover on the tiles to see more info. See the full table under the map. Click on a region to filter the table. <br>
      <div class="disclaimer">* Sevastopol and Crimea are the territories occupied by Russia. We presented them on this map, because data for these regions was availbale on the Russian court websites.</div></p>
      </div>

    <svg id="rf_map" width="800" height="600"></svg>
    
  </div>
  
  <div id="tooltip"></div>

  <div class="container-fluid" id="controls">
    <div class="row" id="year_selectors">
        <div class="col-md-auto" id="col_pad"><p class="all_years">Filter by year</p></div>
        <div class="col-md-auto" id="col_pad"><select class="form-select" id="yearDropdown"></select></div>
        <div class="col-md-auto" id="col_pad"><button type="button" class="btn btn-dark" id="allYearsButton">All years</button></div>
  </div>
  </div>
    
  <div class="container-fluid" id="table-container">
    <div class="table-sm">
    <table class="table table-hover table-dark" id="data-table">
       <thead>
           <tr></tr>
       </thead>
       <tbody class="data-table-body"></tbody>
    </table>
    </div>
  </div>

</div>

<script src="https://d3js.org/d3.v7.min.js"></script>

<script id="jsbin-javascript">
  // Load the SVG map dynamically from GitHub
d3.text("https://raw.githubusercontent.com/dataout-org/datavis/main/rf_tiled_map/tilemaprf_xy.svg")
.then(function(svgString) {
  var parser = new DOMParser();
  var xml = parser.parseFromString(svgString, "image/svg+xml");
  var importedNode = document.importNode(xml.documentElement, true);
  document.getElementById("rf_map").appendChild(importedNode);

  var spreadsheetUrl = "https://docs.google.com/spreadsheets/d/18NSZd6RgeSjEW1RzbYY4lQbFYHWaGKIMb8KLGQuZfDc/export?format=csv";

  // loading csv from the spreadsheet
  d3.text(spreadsheetUrl)
    .then(function(csvData) {
      // Parse the CSV data
      var data = d3.csvParse(csvData);

      //getting years with data
      var uniqueYears = [...new Set(data.map(d => d.year))];
    
    // converting string numbers to integers
    data.forEach(function(d) {
      d.n_victims = +d.n_victims;
      d.n_fatalities = +d.n_fatalities;
      d.n_crimes = +d.n_crimes;
    });

    // getting the year dropdown
    var yearDropdown = document.getElementById("yearDropdown");

    // populating the dropdown
    var uniqueYears = [...new Set(data.map(d => d.year))];
    uniqueYears.sort().reverse(); // desc
    uniqueYears.forEach(function(year) {
      var option = document.createElement("option");
      option.text = year;
      yearDropdown.add(option);
  });

    // listen to the dropdown
    yearDropdown.addEventListener("change", function() {
    // selected year
    var selectedYear = yearDropdown.value;
    updateMap(data, selectedYear);
  });

  // listen to the "All Years"
  var allYearsButton = document.getElementById("allYearsButton");
  allYearsButton.addEventListener("click", function() {
    updateMap(data, null); // null indicates all years
  });

  // by default, showing all years
  updateMap(data, null);
});
});
    
    // updating the map
function updateMap(data, selectedYear) {
  // filter by year
  var filteredData;
  if (selectedYear === null) {
    filteredData = data; // all data if no year
  } else {
    filteredData = data.filter(function(d) {
      return d.year === selectedYear;
    });
  }

    // grouping by region_code and calculate total victims for each region
    var regionData = d3.group(filteredData, d => d.region_code);
    var victimCounts = new Map();

    regionData.forEach(function(value, key) {
      var totalVictims = d3.sum(value, d => d.n_victims);
      victimCounts.set(key, totalVictims);
    });

    // color scale based on the range of victim counts
    var maxVictims = d3.max(Array.from(victimCounts.values()));
    var colorScale = d3.scaleSequential()
      .domain([0, maxVictims])
      .interpolator(function(t) {
        return d3.interpolateReds(t);
      });

    // select the group containing the tiles
    var tilesContainer = d3.select("#tiles_container");
    var textContainer = d3.select("#names_container");
    
    // select the tooltip element
    var tooltip = d3.select("#tooltip");

          // apply colors to the tiles based on the number of victims
          tilesContainer.selectAll("rect").each(function() {
            var tile = d3.select(this);
            var regionCode = tile.attr("id");
            var regionVictims = victimCounts.get(regionCode);
            var fillColor;
            if (regionVictims !== undefined) {
              fillColor = colorScale(regionVictims);
            } else {
              fillColor = "rgb(244, 244, 244)"; // no data tiles
            }
        
            tile.style("fill", fillColor);
            
            // dynamic text color based on perceived brightness
            var textColor = getContrastColor(fillColor);

            var textElement = d3.select("#name_" + regionCode);
            textElement.style("fill", textColor);
            
            // hover on tiles with data
            if (regionVictims !== undefined) {
              tile.on("mouseover", function(event) {
                // tile dimensions and position
                var tileRect = tile.node().getBoundingClientRect();
                var tileLeft = tileRect.left + window.scrollX;
                var tileTop = tileRect.top + window.scrollY;
                // tooltip
                tooltip.style("visibility", "visible")
                      .html(tile.attr("regionNameEn") + "<br> Victims: " + regionVictims)
                      .style("left", (tileLeft + tileRect.width / 2) + "px")
                      .style("top", (tileTop + (tileRect.height / 2)) + "px");
              })
              .on("mouseout", function() {
                // hide tooltip on mouseout
                tooltip.style("visibility", "hidden");
              })
              .on("click", function() {
                  // reset previously selected tiles
                  textContainer.selectAll("text").style("font-weight", "normal");

                  // clicked-on tile is bold
                  textElement.style("font-weight", "bold");
                  // filter by the selected region
                  var cases = filteredData.filter(function(d) {
                    return d.region_code === regionCode;
                  });
        
                  // generate table
                        var tableHTML = "<thead><tr><th>Case Number</th><th>Region (RU)</th><th>Article</th><th>Fatalities</th><th>Victims</th><th>Crimes</th><th>Crime Type</th><th>Source</th></tr></thead><tbody>";
                        cases.forEach(function(d) {
                          tableHTML += "<tr><td>" + d.case_number + "</td><td>" + d.region_name_ru + "</td><td>" + d.article + "</td><td>" + d.n_fatalities + "</td><td>" + d.n_victims + "</td><td>" + d.n_crimes + "</td><td>" + d.crime_type + "</td><td>" + d.source + "</td></tr>";
                        });
                        tableHTML += "</tbody>";

                        // filling the table
                        document.querySelector("#data-table").innerHTML = tableHTML;
                      });
                  }
                });
    
    // initial table with all cases
    var initialTableHTML = "<thead><tr><th>Case Number</th><th>Region (RU)</th><th>Article</th><th>Fatalities</th><th>Victims</th><th>Crimes</th><th>Crime Type</th><th>Source</th></tr></thead><tbody>";
    filteredData.forEach(function(d) {
      initialTableHTML += "<tr><td>" + d.case_number + "</td><td>" + d.region_name_ru + "</td><td>" + d.article + "</td><td>" + d.n_fatalities + "</td><td>" + d.n_victims + "</td><td>" + d.n_crimes + "</td><td>" + d.crime_type + "</td><td>" + d.source + "</td></tr>";
    });
    initialTableHTML += "</tbody>";

    document.querySelector("#data-table").innerHTML = initialTableHTML;
  
}

// function to calculate perceived brightness based on HSL color space
function getPerceivedBrightness(color) {
  var rgb = d3.rgb(color);
  var hsl = d3.hsl(rgb);
  return hsl.l;
}

// function to dynamically determine text color based on perceived brightness
function getContrastColor(bgColor) {
  var brightness = getPerceivedBrightness(bgColor);
  return brightness > 0.5 ? "black" : "white"; // black text for light backgrounds, white text for dark
}

</script>

</body>

</html>